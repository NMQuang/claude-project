# デプロイメント＆ロールバック計画

## ドキュメント情報

| 項目 | 詳細 |
|------|------|
| **プロジェクト名** | {{project.name}} |
| **マイグレーションタイプ** | {{project.migration_type}} |
| **ソース技術** | {{source.language}}{{#if source.database}} / {{source.database}}{{/if}} |
| **ターゲット技術** | {{target.language}}{{#if target.database}} / {{target.database}}{{/if}} |
| **ドキュメントタイプ** | デプロイメント＆ロールバック計画 |
| **作成日** | {{generated_date}} |
| **バージョン** | {{version}} |

---

## エグゼクティブサマリー

**ソース:** マイグレーション分析からデプロイメント範囲を派生

| メトリクス | 値 | ソース参照 |
|------------|------|------------|
| デプロイ対象コンポーネント | {{metadata.source_analysis.total_files}} | マイグレーション設計 |
{{#if metadata.source_analysis.database.tables}}| データベーステーブル | {{metadata.source_analysis.database.tables}} | スキーマ分析 |{{/if}}
{{#if metadata.source_analysis.database.stored_procedures}}| ストアドプロシージャ | {{metadata.source_analysis.database.stored_procedures}} | スキーマ分析 |{{/if}}
| 複雑度レベル | {{metadata.migrationComplexity.difficulty}} | 複雑度分析 |

---

## 1. デプロイメント範囲

### 1.1 デプロイ対象コンポーネント

**ソース:** マイグレーション設計ドキュメント

{{#if deployment.components}}
| コンポーネント | タイプ | ソース参照 | デプロイ順序 |
|----------------|--------|------------|--------------|
{{#each deployment.components}}
| {{this.name}} | {{this.type}} | `{{this.source}}` | {{this.order}} |
{{/each}}
{{else}}
| コンポーネントタイプ | 件数 | ソース |
|----------------------|------|--------|
| マイグレーション済みコード | {{metadata.source_analysis.total_files}}ファイル | マイグレーション出力 |
{{#if metadata.source_analysis.database.tables}}| データベースオブジェクト | {{metadata.source_analysis.database.tables}}テーブル | DDLスクリプト |{{/if}}
| 設定 | マイグレーション設計に従う | 設定ファイル |
{{/if}}

### 1.2 デプロイメント依存関係

**ソース:** 依存関係分析

{{#if deployment.dependencies}}
| コンポーネント | 依存先 | 依存タイプ | ソース参照 |
|----------------|--------|------------|------------|
{{#each deployment.dependencies}}
| {{this.component}} | {{this.depends_on}} | {{this.type}} | `{{this.source}}` |
{{/each}}
{{else}}
> **ソースに見つかりません:** デプロイメント依存関係は依存関係分析が必要です。
{{/if}}

---

## 2. デプロイメント前チェックリスト

### 2.1 コード＆ビルド検証

{{#if pre_deployment.code}}
| チェック項目 | 検証方法 | ステータス | ソース参照 |
|--------------|----------|------------|------------|
{{#each pre_deployment.code}}
| {{this.check}} | {{this.method}} | [ ] | `{{this.source}}` |
{{/each}}
{{else}}
| チェック項目 | 検証方法 | ステータス |
|--------------|----------|------------|
| コードマイグレーション完了 | マイグレーション設計の全ファイル存在 | [ ] |
| ビルド成功 | ビルドコマンド成功 | [ ] |
| 単体テストパス | テストスイート実行 | [ ] |
| 結合テストパス | テストスイート実行 | [ ] |
{{/if}}

### 2.2 データベース検証

{{#if source.database}}

{{#if pre_deployment.database}}
| チェック項目 | 検証方法 | ステータス | ソース参照 |
|--------------|----------|------------|------------|
{{#each pre_deployment.database}}
| {{this.check}} | {{this.method}} | [ ] | `{{this.source}}` |
{{/each}}
{{else}}
| チェック項目 | 検証方法 | ステータス |
|--------------|----------|------------|
| DDLスクリプト検証済み | テスト環境でのスクリプト実行 | [ ] |
| データマイグレーションスクリプト検証済み | テスト環境でのスクリプト実行 | [ ] |
| ストアドプロシージャ検証済み | コンパイルと基本テスト | [ ] |
{{/if}}

{{/if}}

### 2.3 バックアップ検証

{{#if pre_deployment.backup}}
| バックアップ項目 | 場所 | 検証 | ステータス |
|------------------|------|------|------------|
{{#each pre_deployment.backup}}
| {{this.item}} | {{this.location}} | {{this.verification}} | [ ] |
{{/each}}
{{else}}
| バックアップ項目 | 検証 | ステータス |
|------------------|------|------------|
| ソースシステム状態 | バックアップ復元確認済み | [ ] |
{{#if source.database}}| ソースデータベース | フルバックアップ完了 | [ ] |{{/if}}
| 現在のターゲットシステム | スナップショット/バックアップ取得 | [ ] |
{{/if}}

---

## 3. デプロイメント手順

### 3.1 デプロイメント順序

**ソース:** マイグレーション設計からの依存関係分析

{{#if deployment.order}}
| ステップ | コンポーネント | 前提条件 | 検証 | ソース参照 |
|----------|----------------|----------|------|------------|
{{#each deployment.order}}
| {{this.step}} | {{this.component}} | {{this.prerequisites}} | {{this.validation}} | `{{this.source}}` |
{{/each}}
{{else}}
| ステップ | アクション | 前提条件 |
|----------|------------|----------|
{{#if source.database}}| 1 | データベーススキーマデプロイ | バックアップ完了 |{{/if}}
{{#if source.database}}| 2 | データマイグレーション | スキーマデプロイ完了 |{{/if}}
{{#if source.database}}| 3 | ストアドプロシージャ/ファンクションデプロイ | データマイグレーション完了 |{{/if}}
| {{#if source.database}}4{{else}}1{{/if}} | アプリケーションコードデプロイ | {{#if source.database}}DB準備完了{{else}}バックアップ完了{{/if}} |
| {{#if source.database}}5{{else}}2{{/if}} | 設定デプロイ | コードデプロイ完了 |
| {{#if source.database}}6{{else}}3{{/if}} | スモークテスト | 全コンポーネントデプロイ完了 |
{{/if}}

### 3.2 詳細デプロイメントステップ

{{#if deployment.detailed_steps}}
{{#each deployment.detailed_steps}}
#### ステップ {{this.step}}: {{this.name}}

**コンポーネント:** {{this.component}}

**ソース参照:** `{{this.source}}`

**前提条件:**
{{#each this.prerequisites}}
- {{this}}
{{/each}}

**アクション:**
{{#each this.actions}}
{{@index}}. {{this}}
{{/each}}

**検証:**
{{#each this.validation}}
- {{this}}
{{/each}}

**ロールバックポイント:** {{this.rollback_point}}

---

{{/each}}
{{else}}
> **ソースに見つかりません:** 詳細デプロイメントステップは手動仕様が必要です。
{{/if}}

---

## 4. 検証手順

### 4.1 デプロイメント後検証

**ソース:** テスト戦略からの検証基準

{{#if validation.post_deployment}}
| 検証 | 方法 | 期待結果 | ソース参照 |
|------|------|----------|------------|
{{#each validation.post_deployment}}
| {{this.check}} | {{this.method}} | {{this.expected}} | `{{this.source}}` |
{{/each}}
{{else}}
| 検証 | 方法 | 期待結果 |
|------|------|----------|
| アプリケーション起動 | ヘルスチェックエンドポイント | 200 OK |
| 基本機能 | スモークテストスイート | 全パス |
{{#if source.database}}| データベース接続 | 接続テスト | 接続成功 |{{/if}}
{{#if source.database}}| データ整合性 | 行数検証 | ソースと一致 |{{/if}}
{{/if}}

### 4.2 データ検証

{{#if source.database}}

{{#if validation.data}}
| テーブル/オブジェクト | 検証タイプ | クエリ/方法 | 期待値 | ソース |
|----------------------|------------|-------------|--------|--------|
{{#each validation.data}}
| {{this.object}} | {{this.type}} | {{this.query}} | {{this.expected}} | `{{this.source}}` |
{{/each}}
{{else}}
| 検証 | クエリテンプレート | 期待値 |
|------|-------------------|--------|
| 行数 | `SELECT COUNT(*) FROM [table]` | ソースと一致 |
| チェックサム | `SELECT SUM(hash_value) FROM [table]` | ソースと一致 |
| サンプルデータ | 手動検査 | データ正常 |
{{/if}}

{{/if}}

---

## 5. ロールバック計画

### 5.1 ロールバック判断基準

{{#if rollback.criteria}}
| 基準 | 閾値 | 検出方法 | ソース参照 |
|------|------|----------|------------|
{{#each rollback.criteria}}
| {{this.criterion}} | {{this.threshold}} | {{this.detection}} | `{{this.source}}` |
{{/each}}
{{else}}
| 基準 | 閾値 | 検出 |
|------|------|------|
| クリティカル機能障害 | いずれかのクリティカル機能障害 | 検証テスト |
| データ整合性問題 | いずれかのデータ破損 | データ検証 |
| パフォーマンス劣化 | ソースより50%以上遅い | パフォーマンステスト |
| エラー率 | トランザクションの5%以上 | モニタリング |
{{/if}}

### 5.2 ロールバック判断権限

{{#if rollback.authority}}
| 役割 | 権限 | 条件 |
|------|------|------|
{{#each rollback.authority}}
| {{this.role}} | {{this.authority}} | {{this.condition}} |
{{/each}}
{{else}}
| 役割 | 権限 |
|------|------|
| デプロイメントリード | ロールバック開始可能 |
| プロジェクトマネージャー | 通知必須 |
| ビジネスオーナー | 延長ダウンタイムの承認必須 |
{{/if}}

### 5.3 ロールバック手順

{{#if rollback.procedure}}
{{#each rollback.procedure}}
#### ロールバックステップ {{this.step}}: {{this.name}}

**トリガー:** {{this.trigger}}

**アクション:**
{{#each this.actions}}
{{@index}}. {{this}}
{{/each}}

**検証:**
{{#each this.validation}}
- {{this}}
{{/each}}

**ソース参照:** `{{this.source}}`

---

{{/each}}
{{else}}

#### ステップ 1: 新システム停止

**アクション:**
1. アプリケーション/サービス停止
2. 新システムへのルーティング無効化

#### ステップ 2: データベース復元（該当する場合）

{{#if source.database}}
**アクション:**
1. バックアップからデータベース復元
2. 復元完了確認
3. データ整合性検証
{{/if}}

#### ステップ 3: アプリケーション復元

**アクション:**
1. 前バージョンデプロイ
2. 前設定復元
3. アプリケーション起動

#### ステップ 4: 検証

**アクション:**
1. システムヘルス確認
2. スモークテスト実行
3. ステークホルダー確認

{{/if}}

### 5.4 ロールバック検証

{{#if rollback.verification}}
| チェック項目 | 方法 | 期待結果 | ステータス |
|--------------|------|----------|------------|
{{#each rollback.verification}}
| {{this.check}} | {{this.method}} | {{this.expected}} | [ ] |
{{/each}}
{{else}}
| チェック項目 | 期待結果 | ステータス |
|--------------|----------|------------|
| ソースシステム復元 | 全機能動作 | [ ] |
{{#if source.database}}| データベース復元 | データがデプロイメント前と一致 | [ ] |{{/if}}
| データ損失なし | 全データアクセス可能 | [ ] |
| ユーザーアクセス | ユーザーがシステムにアクセス可能 | [ ] |
{{/if}}

---

## 6. ハイパーケア計画

### 6.1 ハイパーケア期間

{{#if hypercare.period}}
| 項目 | 値 | ソース参照 |
|------|------|------------|
| 期間 | {{hypercare.period.duration}} | 複雑度に基づく |
| カバレッジ | {{hypercare.period.coverage}} | - |
| サポートレベル | {{hypercare.period.support_level}} | - |
{{else}}
| 項目 | 値 |
|------|------|
| 期間 | 2-4週間（複雑度に基づく: {{metadata.migrationComplexity.difficulty}}） |
| カバレッジ | 営業時間 + オンコール |
| サポートレベル | L1/L2/L3エスカレーション |
{{/if}}

### 6.2 モニタリングメトリクス

**ソース:** マイグレーション済みコンポーネントに基づく

{{#if hypercare.monitoring}}
| メトリクス | 閾値 | アラート | ソース参照 |
|------------|------|----------|------------|
{{#each hypercare.monitoring}}
| {{this.metric}} | {{this.threshold}} | {{this.alert}} | `{{this.source}}` |
{{/each}}
{{else}}
| メトリクス | 閾値 | アラート |
|------------|------|----------|
| エラー率 | >1% | クリティカル |
| 応答時間 | >ベースライン+20% | 警告 |
| 失敗トランザクション | >0 | クリティカル |
| リソース使用率 | >80% | 警告 |
{{/if}}

### 6.3 インシデントエスカレーション

{{#if hypercare.escalation}}
| 重要度 | 対応時間 | エスカレーションパス | ソース参照 |
|--------|----------|---------------------|------------|
{{#each hypercare.escalation}}
| {{this.severity}} | {{this.response}} | {{this.path}} | `{{this.source}}` |
{{/each}}
{{else}}
| 重要度 | 対応時間 | エスカレーションパス |
|--------|----------|---------------------|
| クリティカル | 15分 | オンコール → リード → マネージャー |
| 高 | 1時間 | オンコール → リード |
| 中 | 4時間 | サポートチーム |
| 低 | 翌営業日 | サポートキュー |
{{/if}}

---

## 7. デプロイメント後タスク

### 7.1 即時タスク（24時間以内）

{{#if post_deployment.immediate}}
| タスク | 担当者 | ステータス |
|--------|--------|------------|
{{#each post_deployment.immediate}}
| {{this.task}} | {{this.owner}} | [ ] |
{{/each}}
{{else}}
| タスク | ステータス |
|--------|------------|
| 全検証パス確認 | [ ] |
| システムドキュメント更新 | [ ] |
| デプロイメント成功通知送信 | [ ] |
| デプロイメント成果物アーカイブ | [ ] |
{{/if}}

### 7.2 短期タスク（1週間以内）

{{#if post_deployment.short_term}}
| タスク | 担当者 | ステータス |
|--------|--------|------------|
{{#each post_deployment.short_term}}
| {{this.task}} | {{this.owner}} | [ ] |
{{/each}}
{{else}}
| タスク | ステータス |
|--------|------------|
| モニタリングメトリクスレビュー | [ ] |
| 報告された問題対応 | [ ] |
| デプロイメント振り返り実施 | [ ] |
| ランブック更新 | [ ] |
{{/if}}

### 7.3 長期タスク（1ヶ月以内）

{{#if post_deployment.long_term}}
| タスク | 担当者 | ステータス |
|--------|--------|------------|
{{#each post_deployment.long_term}}
| {{this.task}} | {{this.owner}} | [ ] |
{{/each}}
{{else}}
| タスク | ステータス |
|--------|------------|
| ソースシステム廃止 | [ ] |
| ソースシステムバックアップアーカイブ | [ ] |
| 災害復旧手順更新 | [ ] |
| ナレッジ移転完了 | [ ] |
{{/if}}

---

## 付録

### 付録A: デプロイメント成果物チェックリスト

{{#if appendix.artifacts}}
| 成果物 | 場所 | 確認済み |
|--------|------|----------|
{{#each appendix.artifacts}}
| {{this.name}} | `{{this.location}}` | [ ] |
{{/each}}
{{else}}
| 成果物 | 確認済み |
|--------|----------|
| アプリケーションパッケージ | [ ] |
| 設定ファイル | [ ] |
{{#if source.database}}| DDLスクリプト | [ ] |{{/if}}
{{#if source.database}}| データマイグレーションスクリプト | [ ] |{{/if}}
| 検証スクリプト | [ ] |
| ロールバックスクリプト | [ ] |
{{/if}}

---

## トレーサビリティノート

このドキュメントのすべてのデプロイメント手順は以下から派生しています:
- **マイグレーション設計:** コンポーネントマッピングと変換詳細
- **ソース分析:** 複雑度と依存関係情報
- **テスト戦略:** 検証要件

「ソースに見つかりません」とマークされた項目は、インフラストラクチャと運用要件に基づく手動仕様が必要です。

---

## ドキュメント履歴

| バージョン | 日付 | 作成者 | 変更内容 |
|------------|------|--------|----------|
| {{version}} | {{generated_date}} | {{author}} | 初版（マイグレーション分析から自動生成） |

---

**デプロイメント＆ロールバック計画終了**
