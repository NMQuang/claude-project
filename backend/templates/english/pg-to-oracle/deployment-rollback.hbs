# Deployment & Rollback Plan (PostgreSQL → Oracle)

## Document Information

| Item | Details |
|------|---------|
| **Project Name** | {{project.name}} |
| **Migration Type** | PostgreSQL → Oracle |
| **Document Type** | Deployment & Rollback Plan |
| **Generated Date** | {{generated_date}} |
| **Version** | {{version}} |

---

## 1. Deployment Scope from Source Analysis

### 1.1 Components to Deploy

**Source:** PostgreSQL inventory and application scan

| Component | Count | Deployment Target | Source |
|-----------|-------|-------------------|--------|
| Database Tables | {{metadata.source_analysis.database.tables}} | Oracle Database | pg_tables |
| Views | {{metadata.source_analysis.database.views}} | Oracle Database | pg_views |
| Functions/Procedures | {{metadata.source_analysis.database.functions}} | Oracle Database | pg_proc |
| Triggers | {{metadata.source_analysis.database.triggers}} | Oracle Database | pg_trigger |
| Sequences | {{metadata.source_analysis.database.sequences}} | Oracle Database | pg_sequences |
| Application Config | Configuration files | Application Server | Code scan |
| Application Code | Modified repositories/entities | Application Server | Code scan |

### 1.2 Deployment Artifacts

**Source:** Migration design output

{{#if deployment.artifacts}}
| Artifact | Source | Description | Target | Source |
|----------|--------|-------------|--------|--------|
{{#each deployment.artifacts}}
| {{this.artifact}} | {{this.origin}} | {{this.description}} | {{this.target}} | `{{this.source}}` |
{{/each}}
{{else}}
| Artifact | Description | Target |
|----------|-------------|--------|
| DDL Scripts | Schema conversion from PostgreSQL | Oracle DB |
| PL/SQL Functions | Converted PL/pgSQL functions | Oracle DB |
| Migration Scripts | Data migration procedures | Oracle DB |
| Application JAR/WAR | Updated application with Oracle driver | App Server |
| Configuration | application.properties with Oracle settings | App Server |

> Artifact list derived from migration design.
{{/if}}

---

## 2. Pre-Deployment Checklist

### 2.1 Database Readiness

**Source:** Oracle environment requirements

{{#if deployment.pre_checks.database}}
| Check | Requirement | Status | Source |
|-------|-------------|--------|--------|
{{#each deployment.pre_checks.database}}
| {{this.check}} | {{this.requirement}} | {{this.status}} | `{{this.source}}` |
{{/each}}
{{else}}
| Check | Requirement | Status |
|-------|-------------|--------|
| Oracle instance | Running and accessible | [ ] Verified |
| Schema created | Target schema exists | [ ] Verified |
| DDL executed | {{metadata.source_analysis.database.tables}} tables created | [ ] Verified |
| Functions deployed | {{metadata.source_analysis.database.functions}} functions created | [ ] Verified |
| Sequences created | {{metadata.source_analysis.database.sequences}} sequences created | [ ] Verified |
| Indexes created | All indexes built | [ ] Verified |
| Constraints enabled | All constraints valid | [ ] Verified |
{{/if}}

### 2.2 Data Migration Readiness

**Source:** Data migration status

{{#if deployment.pre_checks.data}}
| Check | Tables | Status | Source |
|-------|--------|--------|--------|
{{#each deployment.pre_checks.data}}
| {{this.check}} | {{this.tables}} | {{this.status}} | `{{this.source}}` |
{{/each}}
{{else}}
| Check | Requirement | Status |
|-------|-------------|--------|
| Data loaded | All {{metadata.source_analysis.database.tables}} tables | [ ] Verified |
| Row counts match | 100% match with PostgreSQL | [ ] Verified |
| Referential integrity | All FKs valid | [ ] Verified |
| Data checksums | Match PostgreSQL | [ ] Verified |
{{/if}}

### 2.3 Application Readiness

**Source:** Application migration status

{{#if deployment.pre_checks.application}}
| Check | Component | Status | Source |
|-------|-----------|--------|--------|
{{#each deployment.pre_checks.application}}
| {{this.check}} | {{this.component}} | {{this.status}} | `{{this.source}}` |
{{/each}}
{{else}}
| Check | Requirement | Status |
|-------|-------------|--------|
| Config updated | Oracle JDBC settings | [ ] Verified |
| Dependencies updated | Oracle driver added | [ ] Verified |
| Queries converted | {{metadata.source_analysis.nativeQueryCount}} native queries | [ ] Verified |
| Unit tests passing | 100% pass rate | [ ] Verified |
| Integration tests | Oracle integration tests pass | [ ] Verified |
{{/if}}

### 2.4 Backup Verification

**Source:** Backup requirements

| Backup | Location | Verified | Method |
|--------|----------|----------|--------|
| PostgreSQL full | [Path] | [ ] | pg_dump |
| PostgreSQL WAL | [Path] | [ ] | Archive |
| Oracle schema | [Path] | [ ] | expdp |
| Application config | [Path] | [ ] | File copy |
| Application code | [Path] | [ ] | Git tag |

---

## 3. Deployment Procedure

### 3.1 Deployment Strategy

**Source:** Based on complexity score {{metadata.complexity.overall}}/100

{{#if (gt metadata.complexity.overall 70)}}
**Strategy:** Phased Migration with Blue-Green
- Minimal downtime approach
- Parallel systems during transition
- Module-by-module cutover
{{else}}
**Strategy:** Big Bang Cutover
- Single maintenance window
- Direct switch from PostgreSQL to Oracle
- Faster overall completion
{{/if}}

### 3.2 Deployment Steps

#### Step 1: Pre-Deployment Verification
```bash
#!/bin/bash
echo "=== Pre-Deployment Verification ==="

# Check Oracle connectivity
sqlplus -s {{oracle.user}}/{{oracle.password}}@{{oracle.service}} <<EOF
SELECT 'Oracle: CONNECTED' FROM DUAL;
EXIT;
EOF

# Verify row counts
echo "Verifying data migration..."
{{#each metadata.critical_tables}}
sqlplus -s {{../oracle.user}}/{{../oracle.password}}@{{../oracle.service}} <<EOF
SELECT COUNT(*) as {{this}}_count FROM {{this}};
EOF
{{/each}}

# Check application health
curl -f http://localhost:8080/actuator/health || echo "WARNING: App health check failed"
```

#### Step 2: Enable Maintenance Mode
```bash
#!/bin/bash
echo "=== Enabling Maintenance Mode ==="

# Notify users
# Update load balancer to maintenance page

# Stop accepting new connections
curl -X POST http://localhost:8080/admin/maintenance/enable

# Wait for active requests to complete
sleep 60

# Verify no active transactions
psql -h {{postgres.host}} -U {{postgres.user}} -d {{postgres.database}} -c \
  "SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active';"
```

#### Step 3: Stop Application
```bash
#!/bin/bash
echo "=== Stopping Application ==="

systemctl stop application

# Verify stopped
ps aux | grep java | grep -v grep && echo "WARNING: Process still running"

echo "Application stopped"
```

#### Step 4: Final Data Sync (if applicable)
```bash
#!/bin/bash
echo "=== Final Data Synchronization ==="

# Capture final changes since last sync
pg_dump -h {{postgres.host}} -U {{postgres.user}} -d {{postgres.database}} \
  --data-only --inserts -t changed_table > /tmp/delta.sql

# Transform and load to Oracle
# [Custom transformation script]

# Verify sync
echo "Verifying final sync..."
```

#### Step 5: Switch Configuration
```bash
#!/bin/bash
echo "=== Switching to Oracle Configuration ==="

# Backup current config
cp /app/config/application.properties /app/config/application.properties.pg.backup

# Deploy Oracle config
cp /app/config/application-oracle.properties /app/config/application.properties

# Verify configuration
grep "spring.datasource.url" /app/config/application.properties
```

#### Step 6: Deploy Application
```bash
#!/bin/bash
echo "=== Deploying Application ==="

# Deploy new artifact (if changed)
# cp /deployments/app-oracle.jar /app/application.jar

# Start application
systemctl start application

# Wait for startup
sleep 60

# Health check
for i in {1..10}; do
  http_code=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/actuator/health)
  if [ "$http_code" -eq 200 ]; then
    echo "Application started successfully"
    break
  fi
  echo "Waiting for application... ($i/10)"
  sleep 10
done
```

#### Step 7: Smoke Tests
```bash
#!/bin/bash
echo "=== Running Smoke Tests ==="

# Basic health
curl -f http://localhost:8080/actuator/health || exit 1

# Database connectivity
curl -f http://localhost:8080/api/health/db || exit 1

# CRUD operations test
# [Application-specific tests]

echo "Smoke tests passed"
```

#### Step 8: Disable Maintenance Mode
```bash
#!/bin/bash
echo "=== Going Live ==="

curl -X POST http://localhost:8080/admin/maintenance/disable

echo "Application is now live on Oracle"
```

---

## 4. Validation Procedures

### 4.1 Post-Deployment Validation

**Source:** Migration validation requirements

{{#if deployment.validation.checks}}
| Check | Method | Expected | Status |
|-------|--------|----------|--------|
{{#each deployment.validation.checks}}
| {{this.check}} | {{this.method}} | {{this.expected}} | [ ] |
{{/each}}
{{else}}
| Check | Method | Expected |
|-------|--------|----------|
| Application health | /actuator/health | UP |
| Database connection | /api/health/db | Connected |
| Table access | Query each table | Success |
| Function execution | Call each function | Expected results |
| API endpoints | Test key endpoints | 200 OK |
| Data integrity | Row count validation | Match baseline |
{{/if}}

### 4.2 Data Validation Queries

**Source:** Data migration design

```sql
-- Run on Oracle
-- Row count validation for critical tables
{{#each metadata.critical_tables}}
SELECT '{{this}}' as table_name, COUNT(*) as row_count FROM {{this}};
{{/each}}

-- Constraint validation
SELECT constraint_name, status
FROM user_constraints
WHERE status != 'ENABLED';
-- Should return 0 rows

-- Orphaned record check
-- [Application-specific FK validation queries]
```

### 4.3 Performance Validation

**Source:** Performance baseline

```bash
#!/bin/bash
echo "=== Performance Validation ==="

# Test key queries
for i in {1..10}; do
  start=$(date +%s%N)
  curl -s http://localhost:8080/api/users > /dev/null
  end=$(date +%s%N)
  duration=$(( (end - start) / 1000000 ))
  echo "Query $i: ${duration}ms"
done

# Compare with baseline
# Alert if >20% degradation
```

---

## 5. Rollback Plan

### 5.1 Rollback Decision Criteria

**Source:** Risk assessment

| Trigger | Threshold | Priority |
|---------|-----------|----------|
| Data integrity error | Any data corruption | CRITICAL |
| Application error rate | >1% of requests | CRITICAL |
| Performance degradation | >50% slower | HIGH |
| Function failure | Any critical function | HIGH |
| Constraint violation | Any FK/PK error | HIGH |
| Unresolved issue | After 2 hours | MEDIUM |

### 5.2 Rollback Authority

- **Technical Lead:** Can initiate for technical issues
- **Project Manager:** Can initiate for timeline/risk issues
- **Business Owner:** Can initiate for business impact

### 5.3 Rollback Procedure

#### Step R1: Declare Rollback
```bash
#!/bin/bash
echo "========================================="
echo "INITIATING ROLLBACK TO POSTGRESQL"
echo "Time: $(date)"
echo "Reason: [SPECIFY REASON]"
echo "========================================="

# Log decision
echo "$(date) - ROLLBACK INITIATED" >> /var/log/deployment.log
```

#### Step R2: Stop Application
```bash
#!/bin/bash
echo "=== Stopping Application ==="

systemctl stop application

# Verify stopped
sleep 10
ps aux | grep java | grep -v grep && echo "ERROR: Process still running" && exit 1
```

#### Step R3: Restore PostgreSQL Configuration
```bash
#!/bin/bash
echo "=== Restoring PostgreSQL Configuration ==="

# Restore backup config
cp /app/config/application.properties.pg.backup /app/config/application.properties

# Verify
grep "postgresql" /app/config/application.properties && echo "PostgreSQL config restored"
```

#### Step R4: Sync Data Back (if needed)
```bash
#!/bin/bash
echo "=== Data Synchronization (if applicable) ==="

# If data was written to Oracle during the brief period
# Sync back to PostgreSQL

# Check for changes
oracle_changes=$(sqlplus -s {{oracle.user}}/{{oracle.password}}@{{oracle.service}} <<EOF
SELECT COUNT(*) FROM audit_log WHERE timestamp > TO_TIMESTAMP('{{cutover_time}}', 'YYYY-MM-DD HH24:MI:SS');
EXIT;
EOF
)

if [ "$oracle_changes" -gt 0 ]; then
  echo "WARNING: $oracle_changes changes detected in Oracle"
  echo "Running reverse sync..."
  # [Custom sync script]
fi
```

#### Step R5: Restart Application on PostgreSQL
```bash
#!/bin/bash
echo "=== Restarting Application ==="

systemctl start application

# Wait and verify
sleep 60

http_code=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/actuator/health)
if [ "$http_code" -eq 200 ]; then
  echo "SUCCESS: Application rolled back to PostgreSQL"
else
  echo "ERROR: Rollback failed - Manual intervention required"
  exit 1
fi
```

#### Step R6: Validate Rollback
```bash
#!/bin/bash
echo "=== Validating Rollback ==="

# Database connectivity
psql -h {{postgres.host}} -U {{postgres.user}} -d {{postgres.database}} -c "SELECT 1;"

# Application health
curl -f http://localhost:8080/actuator/health

# Basic operations
curl -f http://localhost:8080/api/health/db

echo "Rollback validation complete"
```

#### Step R7: Notify Stakeholders
```
Subject: [URGENT] {{project.name}} - Deployment Rolled Back

The Oracle migration has been rolled back to PostgreSQL.

Reason: [REASON]
Time: [TIME]
Status: System operational on PostgreSQL

Next Steps:
1. Root cause analysis
2. Issue resolution
3. Reschedule deployment

Contact: [TEAM CONTACT]
```

### 5.4 Rollback Timeline

**Estimated Rollback Duration:** 15-30 minutes

```
[Decision] → [Stop App: 5m] → [Restore Config: 5m] → [Start App: 10m] → [Validate: 10m] → [Notify: 5m]
```

---

## 6. Post-Deployment Monitoring

### 6.1 Monitoring Targets

**Source:** Component inventory and criticality

| Target | Metric | Threshold | Alert |
|--------|--------|-----------|-------|
| Application | Health status | != UP | Critical |
| Application | Error rate | >1% | High |
| Application | Response time | >2s avg | Medium |
| Oracle | Active sessions | >80% max | Medium |
| Oracle | Query time | >5s | Medium |
| Oracle | Tablespace | >90% | High |

### 6.2 Monitoring Schedule

| Period | Frequency | Focus |
|--------|-----------|-------|
| 0-4 hours | Continuous | All metrics |
| 4-24 hours | Every 15 min | Health, errors |
| Day 2-7 | Hourly | Performance trends |
| Week 2-4 | Daily | Stability |

### 6.3 Escalation Path

| Level | Contact | Trigger |
|-------|---------|---------|
| L1 | On-call engineer | Any alert |
| L2 | Technical Lead | Unresolved >30m |
| L3 | Project Manager | Business impact |
| L4 | Management | Critical/prolonged |

---

## 7. Post-Deployment Tasks

### 7.1 Immediate (0-24 hours)

- [ ] Monitor all metrics continuously
- [ ] Document any issues encountered
- [ ] Verify all business operations functional
- [ ] Communicate status to stakeholders
- [ ] Keep rollback capability ready

### 7.2 Short-term (Week 1)

- [ ] Complete data validation reports
- [ ] Performance comparison analysis
- [ ] User feedback collection
- [ ] Issue resolution tracking
- [ ] Daily status reports

### 7.3 Long-term (Month 1)

- [ ] PostgreSQL decommissioning plan
- [ ] Archive PostgreSQL data
- [ ] Update disaster recovery procedures
- [ ] Knowledge transfer sessions
- [ ] Lessons learned documentation

---

## Appendices

### Appendix A: Deployment Scripts

{{#if appendix.deployment_scripts}}
```bash
{{{appendix.deployment_scripts}}}
```
{{/if}}

### Appendix B: Rollback Scripts

{{#if appendix.rollback_scripts}}
```bash
{{{appendix.rollback_scripts}}}
```
{{/if}}

### Appendix C: Validation Queries

{{#if appendix.validation_queries}}
```sql
{{{appendix.validation_queries}}}
```
{{/if}}

### Appendix D: Contact List

{{#if appendix.contacts}}
| Role | Name | Phone | Email |
|------|------|-------|-------|
{{#each appendix.contacts}}
| {{this.role}} | {{this.name}} | {{this.phone}} | {{this.email}} |
{{/each}}
{{/if}}

---

## Traceability Note

All deployment procedures in this document are derived from PostgreSQL source analysis and migration design. Component counts and validation criteria are traced to source inventory. Items require verification before deployment.

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| {{version}} | {{generated_date}} | {{author}} | Auto-generated from source analysis |

---

**End of Deployment & Rollback Plan**
