# Migration Design Document (PostgreSQL → Oracle)

## Document Information

| Item | Details |
|------|---------|
| **Project Name** | {{project.name}} |
| **Migration Type** | PostgreSQL → Oracle |
| **Document Type** | Migration Design |
| **Generated Date** | {{generated_date}} |
| **Version** | {{version}} |

---

## 1. Schema Conversion Design

### 1.1 Table Conversion from Source DDL

**Source:** pg_dump DDL extraction

{{#if design.table_conversion}}
{{#each design.table_conversion}}
#### Table: {{this.table_name}}

**Source DDL:** `{{this.source_path}}`

**PostgreSQL Definition:**
```sql
{{{this.pg_ddl}}}
```

**Oracle Conversion:**
```sql
{{{this.oracle_ddl}}}
```

**Column Type Mappings:**
| Column | PostgreSQL Type | Oracle Type | Conversion Notes | Source Line |
|--------|-----------------|-------------|------------------|-------------|
{{#each this.columns}}
| {{this.name}} | {{this.pgType}} | {{this.oracleType}} | {{this.notes}} | {{this.line}} |
{{/each}}

---

{{/each}}
{{else}}
> **Not found in source:** Table conversion requires DDL extraction.
{{/if}}

### 1.2 SERIAL/Identity Column Design

**Source:** SERIAL and IDENTITY column extraction

{{#if design.serial_conversion}}
{{#each design.serial_conversion}}
#### Table: {{this.table}}

**Source Column:** `{{this.column}}` ({{this.pgType}})

**Oracle Design:**

**Sequence:**
```sql
CREATE SEQUENCE {{this.sequence_name}}
  START WITH {{this.start_value}}
  INCREMENT BY {{this.increment}}
  {{#if this.cache}}CACHE {{this.cache}}{{else}}NOCACHE{{/if}}
  NOCYCLE;
```

**Trigger:**
```sql
CREATE OR REPLACE TRIGGER {{this.trigger_name}}
BEFORE INSERT ON {{this.table}}
FOR EACH ROW
WHEN (NEW.{{this.column}} IS NULL)
BEGIN
  SELECT {{this.sequence_name}}.NEXTVAL INTO :NEW.{{this.column}} FROM DUAL;
END;
/
```

**Source:** `{{this.source}}`

---

{{/each}}
{{else}}
> **Not found in source:** SERIAL column design requires DDL analysis.
{{/if}}

### 1.3 Constraint Conversion

**Source:** pg_constraint catalog extraction

{{#if design.constraint_conversion}}
| Constraint Name | Type | Table | PostgreSQL Definition | Oracle Conversion | Source |
|-----------------|------|-------|----------------------|-------------------|--------|
{{#each design.constraint_conversion}}
| {{this.name}} | {{this.type}} | {{this.table}} | {{this.pgDef}} | {{this.oracleDef}} | `{{this.source}}` |
{{/each}}
{{else}}
> **Not found in source:** Constraint conversion requires catalog extraction.
{{/if}}

---

## 2. Index Conversion Design

### 2.1 Standard Index Conversion

**Source:** pg_indexes catalog extraction

{{#if design.index_conversion}}
{{#each design.index_conversion}}
#### Index: {{this.name}}

**Source:** `{{this.source}}`

**PostgreSQL Definition:**
```sql
{{{this.pg_ddl}}}
```

**Oracle Conversion:**
```sql
{{{this.oracle_ddl}}}
```

**Conversion Notes:** {{this.notes}}

---

{{/each}}
{{else}}
> **Not found in source:** Index conversion requires catalog extraction.
{{/if}}

### 2.2 Advanced Index Conversion

**Source:** GIN, GiST, BRIN index extraction

{{#if design.advanced_index_conversion}}
{{#each design.advanced_index_conversion}}
#### Index: {{this.name}} ({{this.type}})

**Source:** `{{this.source}}`

**PostgreSQL Definition:**
```sql
{{{this.pg_ddl}}}
```

**Oracle Alternative Design:**
```sql
{{{this.oracle_ddl}}}
```

**Design Rationale:** {{this.rationale}}

---

{{/each}}
{{else}}
| Index Type | Oracle Design Pattern |
|------------|----------------------|
| GIN (JSONB) | Function-based index on JSON_VALUE() |
| GIN (Array) | Nested table with index |
| GIN (Full-text) | Oracle Text CONTEXT index |
| GiST (Geometry) | Oracle Spatial SPATIAL_INDEX |
| BRIN | Partitioned table with local indexes |

> Advanced index design requires index analysis.
{{/if}}

---

## 3. View Conversion Design

### 3.1 View Definitions

**Source:** View DDL extraction

{{#if design.view_conversion}}
{{#each design.view_conversion}}
#### View: {{this.name}}

**Source:** `{{this.source}}`

**PostgreSQL Definition:**
```sql
{{{this.pg_ddl}}}
```

**PostgreSQL Features Used:**
{{#each this.pgFeatures}}
- {{this}}
{{/each}}

**Oracle Conversion:**
```sql
{{{this.oracle_ddl}}}
```

**Conversion Notes:** {{this.notes}}

---

{{/each}}
{{else}}
> **Not found in source:** View conversion requires DDL extraction.
{{/if}}

---

## 4. PL/pgSQL to PL/SQL Conversion Design

### 4.1 Function Conversion

**Source:** pg_proc function body extraction

{{#if design.function_conversion}}
{{#each design.function_conversion}}
#### Function: {{this.name}}

**Source:** `{{this.source}}`

**PostgreSQL PL/pgSQL:**
```sql
{{{this.pg_function}}}
```

**Oracle PL/SQL:**
```sql
{{{this.oracle_function}}}
```

**Conversion Details:**
| Line | PL/pgSQL Construct | PL/SQL Equivalent | Notes |
|------|-------------------|-------------------|-------|
{{#each this.conversions}}
| {{this.line}} | {{this.pgConstruct}} | {{this.oracleConstruct}} | {{this.notes}} |
{{/each}}

---

{{/each}}
{{else}}
> **Not found in source:** Function conversion requires body extraction.
{{/if}}

### 4.2 Trigger Conversion

**Source:** Trigger definition extraction

{{#if design.trigger_conversion}}
{{#each design.trigger_conversion}}
#### Trigger: {{this.name}}

**Table:** {{this.table}}

**Source:** `{{this.source}}`

**PostgreSQL Trigger + Function:**
```sql
{{{this.pg_trigger}}}
```

**Oracle Trigger:**
```sql
{{{this.oracle_trigger}}}
```

---

{{/each}}
{{else}}
> **Not found in source:** Trigger conversion requires definition extraction.
{{/if}}

### 4.3 Type Object Definitions

**Source:** Custom type extraction for pipelined functions

{{#if design.type_definitions}}
{{#each design.type_definitions}}
**Type for:** {{this.purpose}}

```sql
{{{this.definition}}}
```

---

{{/each}}
{{else}}
> **Not found in source:** Type definitions depend on function analysis.
{{/if}}

---

## 5. SQL Query Conversion Design

### 5.1 Pattern-Based Conversion

**Source:** SQL pattern extraction from application code

{{#if design.sql_patterns}}
{{#each design.sql_patterns}}
#### Pattern: {{this.pattern}}

**Occurrences:** {{this.count}}

**PostgreSQL Example:**
```sql
{{{this.pgExample}}}
```

**Oracle Conversion:**
```sql
{{{this.oracleExample}}}
```

**Affected Locations:**
| File | Method/Query | Source |
|------|--------------|--------|
{{#each this.locations}}
| {{this.file}} | {{this.method}} | `{{this.source}}` |
{{/each}}

---

{{/each}}
{{else}}
| Pattern | PostgreSQL | Oracle |
|---------|------------|--------|
| Pagination | LIMIT n OFFSET m | FETCH FIRST n ROWS ONLY OFFSET m |
| Upsert | ON CONFLICT DO UPDATE | MERGE INTO |
| Case-insensitive | ILIKE | UPPER() LIKE UPPER() |
| Array aggregation | array_agg() | LISTAGG() |
| String aggregation | string_agg() | LISTAGG() |
| JSON access | ->>, -> | JSON_VALUE(), JSON_QUERY() |
| Type cast | ::type | CAST() |
| Current time | NOW() | SYSTIMESTAMP |
| Epoch extract | EXTRACT(epoch FROM) | (date - DATE '1970-01-01') * 86400 |

> Pattern conversion requires SQL extraction.
{{/if}}

### 5.2 Native Query Conversion

**Source:** @Query annotation extraction

{{#if design.native_query_conversion}}
{{#each design.native_query_conversion}}
#### Repository: {{this.repository}}

**File:** `{{this.file}}`

##### Method: {{this.method}}

**Original PostgreSQL:**
```sql
{{{this.pgQuery}}}
```

**Oracle Conversion:**
```sql
{{{this.oracleQuery}}}
```

**Keep Unchanged:**
- Method signature: `{{this.signature}}`
- Return type: `{{this.returnType}}`
- Parameters: `{{this.parameters}}`

---

{{/each}}
{{else}}
> **Not found in source:** Native query conversion requires code scan.
{{/if}}

---

## 6. Application Configuration Design

### 6.1 Configuration File Changes

**Source:** Application configuration extraction

{{#if design.config_changes}}
{{#each design.config_changes}}
#### File: {{this.file}}

**Source:** `{{this.path}}`

**Changes:**
| Property | PostgreSQL Value | Oracle Value |
|----------|------------------|--------------|
{{#each this.properties}}
| {{this.property}} | `{{this.pgValue}}` | `{{this.oracleValue}}` |
{{/each}}

---

{{/each}}
{{else}}
**application.properties / application.yml:**

```properties
# JDBC Driver
spring.datasource.driver-class-name=oracle.jdbc.OracleDriver

# Connection URL
spring.datasource.url=jdbc:oracle:thin:@//host:1521/service

# Hibernate Dialect
spring.jpa.database-platform=org.hibernate.dialect.Oracle12cDialect

# Optional: Oracle-specific
spring.datasource.hikari.connection-test-query=SELECT 1 FROM DUAL
```

> Configuration design requires file scan.
{{/if}}

### 6.2 Dependency Changes

**Source:** pom.xml / build.gradle extraction

{{#if design.dependency_changes}}
| Dependency | Current (PostgreSQL) | New (Oracle) | Source |
|------------|---------------------|--------------|--------|
{{#each design.dependency_changes}}
| {{this.name}} | {{this.current}} | {{this.new}} | `{{this.source}}` |
{{/each}}
{{else}}
**Maven (pom.xml):**
```xml
<!-- Remove -->
<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
</dependency>

<!-- Add -->
<dependency>
    <groupId>com.oracle.database.jdbc</groupId>
    <artifactId>ojdbc11</artifactId>
    <version>21.x.x.x</version>
</dependency>
```
{{/if}}

---

## 7. Entity Mapping Design

### 7.1 Entity Annotation Changes

**Source:** JPA Entity class scan

{{#if design.entity_changes}}
{{#each design.entity_changes}}
#### Entity: {{this.entity}}

**File:** `{{this.file}}`

**Current PostgreSQL Mapping:**
```java
{{{this.currentMapping}}}
```

**Oracle Mapping:**
```java
{{{this.oracleMapping}}}
```

**Fields Changed:**
| Field | Change | Reason |
|-------|--------|--------|
{{#each this.fieldChanges}}
| {{this.field}} | {{this.change}} | {{this.reason}} |
{{/each}}

---

{{/each}}
{{else}}
**Common Entity Changes:**

```java
// SERIAL/BIGSERIAL → SEQUENCE
// Before
@GeneratedValue(strategy = GenerationType.IDENTITY)

// After
@GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "seq_gen")
@SequenceGenerator(name = "seq_gen", sequenceName = "TABLE_SEQ", allocationSize = 1)

// JSONB → CLOB
// Before
@Column(columnDefinition = "jsonb")

// After
@Column(columnDefinition = "CLOB")
@Lob

// UUID → RAW or VARCHAR2
// Before
@Column(columnDefinition = "uuid")

// After
@Column(length = 36) // or use RAW(16) with converter
```

> Entity design requires code scan.
{{/if}}

---

## 8. Data Migration Design

### 8.1 Migration Script Design

**Source:** Data transformation requirements

{{#if design.migration_scripts}}
{{#each design.migration_scripts}}
#### Script: {{this.name}}

**Purpose:** {{this.purpose}}

**Tables:** {{this.tables}}

**Script:**
```sql
{{{this.script}}}
```

**Source:** {{this.source}}

---

{{/each}}
{{else}}
**General Migration Script Template:**

```sql
-- 1. Extract from PostgreSQL
COPY (SELECT * FROM table_name) TO '/tmp/table_name.csv' CSV HEADER;

-- 2. Transform (Python/SQL script)
-- Handle BOOLEAN → NUMBER(1)
-- Handle ARRAY → VARCHAR2
-- Handle JSONB → CLOB

-- 3. Load to Oracle
sqlldr userid=user/pass@orcl control=table_name.ctl
```

> Migration scripts require data analysis.
{{/if}}

### 8.2 Data Validation Queries

**Source:** Schema and data analysis

{{#if design.validation_queries}}
{{#each design.validation_queries}}
#### Validation: {{this.name}}

**PostgreSQL Query:**
```sql
{{{this.pgQuery}}}
```

**Oracle Query:**
```sql
{{{this.oracleQuery}}}
```

**Expected:** {{this.expected}}

---

{{/each}}
{{else}}
**Standard Validation Queries:**

```sql
-- Row count validation
-- PostgreSQL
SELECT 'table_name' as table_name, COUNT(*) FROM table_name;

-- Oracle
SELECT 'table_name' as table_name, COUNT(*) FROM table_name;

-- Compare results

-- Checksum validation
-- PostgreSQL
SELECT MD5(string_agg(column::text, ',' ORDER BY id)) FROM table_name;

-- Oracle
SELECT RAWTOHEX(DBMS_CRYPTO.HASH(
  UTL_RAW.CAST_TO_RAW(LISTAGG(column, ',') WITHIN GROUP (ORDER BY id)),
  2)) FROM table_name;
```
{{/if}}

---

## 9. Rollback Design

### 9.1 Rollback Scripts

**Source:** Migration design (reverse operations)

{{#if design.rollback_scripts}}
{{#each design.rollback_scripts}}
#### Rollback: {{this.name}}

**Reverses:** {{this.reverses}}

**Script:**
```bash
{{{this.script}}}
```

---

{{/each}}
{{else}}
**Application Rollback:**
```bash
# Restore PostgreSQL configuration
cp application.properties.pg.backup application.properties

# Restart application
systemctl restart application

# Verify
curl http://localhost:8080/actuator/health
```

**Database Rollback:**
```bash
# If data was changed, sync back from Oracle
# (Only if needed and possible)
```
{{/if}}

---

## 10. Performance Design Considerations

### 10.1 Index Optimization

**Source:** Query pattern and index analysis

{{#if design.performance.indexes}}
| Table | Recommended Index | Reason | Source Query |
|-------|-------------------|--------|--------------|
{{#each design.performance.indexes}}
| {{this.table}} | {{this.index}} | {{this.reason}} | `{{this.source}}` |
{{/each}}
{{else}}
> **Not found in source:** Performance design requires query analysis.
{{/if}}

### 10.2 Query Optimization

**Source:** Complex query analysis

{{#if design.performance.queries}}
| Query | PostgreSQL Plan | Oracle Plan | Optimization |
|-------|-----------------|-------------|--------------|
{{#each design.performance.queries}}
| {{this.query}} | {{this.pgPlan}} | {{this.oraclePlan}} | {{this.optimization}} |
{{/each}}
{{else}}
> Performance optimization requires execution plan analysis.
{{/if}}

---

## Appendices

### Appendix A: Complete DDL Conversion Scripts

{{#if appendix.ddl_scripts}}
```sql
{{{appendix.ddl_scripts}}}
```
{{/if}}

### Appendix B: PL/SQL Function Library

{{#if appendix.plsql_functions}}
```sql
{{{appendix.plsql_functions}}}
```
{{/if}}

### Appendix C: Data Migration Scripts

{{#if appendix.migration_scripts}}
```bash
{{{appendix.migration_scripts}}}
```
{{/if}}

---

## Traceability Note

All design decisions in this document are derived from PostgreSQL source analysis. Each conversion includes source evidence (file, line number, DDL). Items marked "Not found in source" require manual design.

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| {{version}} | {{generated_date}} | {{author}} | Auto-generated from source analysis |

---

**End of Migration Design Document**
