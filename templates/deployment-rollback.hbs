# Deployment & Rollback Plan

## Document Information

| Item | Details |
|------|---------|
| **Project Name** | {{project.name}} |
| **Migration Type** | {{project.migration_type}} |
| **Document Type** | Deployment & Rollback Plan |
| **Generated Date** | {{generated_date}} |
| **Version** | {{version}} |
| **Author** | {{author}} |

---

## Executive Summary

This document provides a comprehensive plan for deploying the migrated **{{project.name}}** system to production and the procedures for rolling back in case of critical issues. It covers pre-deployment preparations, deployment steps, validation procedures, and rollback strategies.

### Deployment Approach

{{#if deployment.approach}}
{{deployment.approach}}
{{else}}
**Selected Strategy:** Phased deployment with blue-green deployment pattern

**Rationale:** Minimizes risk, allows quick rollback, zero-downtime deployment
{{/if}}

---

## 1. Deployment Overview

### 1.1 Deployment Scope

{{#if scope.components}}
| Component | Description | Version |
|-----------|-------------|---------|
{{#each scope.components}}
| {{this.name}} | {{this.description}} | {{this.version}} |
{{/each}}
{{else}}
| Component | Description | Version |
|-----------|-------------|---------|
| Application | {{target.language}} application | {{app_version}} |
| Database | {{target.database}} database | {{db_version}} |
| Configuration | Environment configs | {{config_version}} |
{{/if}}

### 1.2 Deployment Timeline

{{#if timeline.schedule}}
| Activity | Date/Time | Duration | Responsible |
|----------|-----------|----------|-------------|
{{#each timeline.schedule}}
| {{this.activity}} | {{this.datetime}} | {{this.duration}} | {{this.responsible}} |
{{/each}}
{{else}}
*[To be defined based on production schedule]*

**Proposed Deployment Window:**
- **Date:** [Weekend/Holiday preferred]
- **Time:** 2:00 AM - 6:00 AM (low traffic period)
- **Duration:** 4 hours (including validation)
{{/if}}

### 1.3 Deployment Team

{{#if team}}
| Role | Name | Contact | Responsibility |
|------|------|---------|----------------|
{{#each team}}
| {{this.role}} | {{this.name}} | {{this.contact}} | {{this.responsibility}} |
{{/each}}
{{else}}
| Role | Name | Contact | Responsibility |
|------|------|---------|----------------|
| Deployment Lead | TBD | TBD | Overall coordination |
| Application Lead | TBD | TBD | Application deployment |
| Database Lead | TBD | TBD | Database migration |
| DevOps Engineer | TBD | TBD | Infrastructure, scripts |
| QA Lead | TBD | TBD | Validation testing |
| Business SME | TBD | TBD | Business validation |
{{/if}}

---

## 2. Pre-Deployment Checklist

### 2.1 Environment Preparation

{{#if pre_deployment.environment}}
{{#each pre_deployment.environment}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] Production environment verified and accessible
- [ ] Server resources verified (CPU, memory, disk space)
- [ ] Network connectivity tested
- [ ] Load balancer configured
- [ ] SSL certificates installed and valid
- [ ] DNS entries updated (if required)
- [ ] Firewall rules configured
- [ ] Monitoring and alerting configured
{{/if}}

### 2.2 Code & Database Preparation

{{#if pre_deployment.code}}
{{#each pre_deployment.code}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] Code freeze enforced
- [ ] All code merged to release branch
- [ ] Release branch tagged (e.g., v1.0.0)
- [ ] Application artifact built (JAR/WAR)
- [ ] Database migration scripts tested in staging
- [ ] Configuration files prepared for production
- [ ] All UAT defects resolved
- [ ] UAT sign-off obtained
{{/if}}

### 2.3 Backup & Recovery

{{#if pre_deployment.backup}}
{{#each pre_deployment.backup}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] Full database backup completed
- [ ] Backup verified and restorable
- [ ] Application configuration backed up
- [ ] Current application version archived
- [ ] Backup stored in secure location
- [ ] Recovery time tested (RTO validated)
{{/if}}

### 2.4 Communication & Approval

{{#if pre_deployment.communication}}
{{#each pre_deployment.communication}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] Deployment plan reviewed and approved
- [ ] Stakeholders notified of deployment window
- [ ] Change Advisory Board (CAB) approval obtained
- [ ] Downtime notification sent to users
- [ ] Support team briefed on changes
- [ ] Escalation contacts confirmed
{{/if}}

---

## 3. Deployment Procedure

### 3.1 Deployment Strategy

{{#if deployment.strategy}}
{{deployment.strategy}}
{{else}}
**Blue-Green Deployment:**

```
┌─────────────────────────────────────────────┐
│         Load Balancer                       │
└──────────────┬──────────────────────────────┘
               │
       ┌───────┴────────┐
       │                │
   ┌───▼───┐        ┌───▼───┐
   │ BLUE  │        │ GREEN │
   │(Old)  │        │(New)  │
   └───┬───┘        └───┬───┘
       │                │
   ┌───▼────────────────▼───┐
   │      Database          │
   └────────────────────────┘

1. Deploy new version to GREEN environment
2. Test GREEN environment
3. Switch traffic from BLUE to GREEN
4. Monitor for issues
5. Keep BLUE running for quick rollback
```
{{/if}}

### 3.2 Detailed Deployment Steps

#### Step 1: Pre-Deployment Verification
```bash
{{#if deployment.steps.pre_verification}}
{{{deployment.steps.pre_verification}}}
{{else}}
# Verify current system status
curl -f https://api.example.com/health || echo "Current system DOWN"

# Check database connectivity
psql -h prod-db -U app_user -c "SELECT 1"

# Verify backup completed
ls -lh /backups/db_backup_$(date +%Y%m%d).sql
{{/if}}
```

#### Step 2: Enable Maintenance Mode (If Applicable)
```bash
{{#if deployment.steps.maintenance_mode}}
{{{deployment.steps.maintenance_mode}}}
{{else}}
# Display maintenance page to users
# Route traffic to maintenance page via load balancer
{{/if}}
```

#### Step 3: Database Migration
```bash
{{#if deployment.steps.db_migration}}
{{{deployment.steps.db_migration}}}
{{else}}
# Run database migration scripts
cd /opt/migration

# Execute schema migration
psql -h prod-db -U app_user -d app_db -f schema_migration.sql

# Execute data migration
./data_migration.sh

# Verify migration
psql -h prod-db -U app_user -d app_db -f verify_migration.sql
{{/if}}
```

**Migration Scripts:**
{{#if deployment.migration_scripts}}
{{#each deployment.migration_scripts}}
- `{{this.file}}`: {{this.description}}
{{/each}}
{{/if}}

#### Step 4: Application Deployment
```bash
{{#if deployment.steps.app_deployment}}
{{{deployment.steps.app_deployment}}}
{{else}}
# Deploy application to GREEN environment
scp target/app-1.0.0.jar prod-green:/opt/app/

# Deploy configuration
scp config/application-prod.yml prod-green:/opt/app/config/

# Start application on GREEN
ssh prod-green "systemctl start app-green"

# Wait for application to start
sleep 30

# Health check
curl -f http://prod-green:8080/actuator/health
{{/if}}
```

#### Step 5: Smoke Testing
```bash
{{#if deployment.steps.smoke_test}}
{{{deployment.steps.smoke_test}}}
{{else}}
# Run automated smoke tests on GREEN environment
./smoke_tests.sh http://prod-green:8080

# Manual verification:
# - Login functionality
# - Critical business operations
# - Database connectivity
{{/if}}
```

**Smoke Test Checklist:**
{{#if deployment.smoke_tests}}
{{#each deployment.smoke_tests}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] Application started successfully
- [ ] Health endpoint returns 200 OK
- [ ] Database connection successful
- [ ] User login works
- [ ] Critical API endpoints respond
- [ ] No errors in application logs
{{/if}}

#### Step 6: Traffic Switchover
```bash
{{#if deployment.steps.switchover}}
{{{deployment.steps.switchover}}}
{{else}}
# Update load balancer to route traffic to GREEN
# Option 1: Gradual (canary deployment)
# - Route 10% traffic to GREEN, monitor
# - Route 50% traffic to GREEN, monitor
# - Route 100% traffic to GREEN

# Option 2: Immediate switchover
./switch_traffic.sh --from blue --to green

# Verify traffic routing
curl -H "Host: api.example.com" http://load-balancer/health
{{/if}}
```

#### Step 7: Post-Deployment Monitoring
```bash
{{#if deployment.steps.monitoring}}
{{{deployment.steps.monitoring}}}
{{else}}
# Monitor application logs
tail -f /var/log/app/application.log

# Monitor database connections
psql -h prod-db -c "SELECT count(*) FROM pg_stat_activity WHERE datname='app_db'"

# Monitor system resources
top
df -h

# Check error rates in monitoring dashboard
# - Application errors
# - API response times
# - Database query performance
{{/if}}
```

**Monitoring Checklist (First 30 minutes):**
{{#if deployment.monitoring}}
{{#each deployment.monitoring}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] No application errors in logs
- [ ] API response times within acceptable range
- [ ] Database queries performing normally
- [ ] CPU/Memory utilization normal
- [ ] No user-reported issues
- [ ] Business transactions completing successfully
{{/if}}

#### Step 8: Disable Maintenance Mode
```bash
{{#if deployment.steps.disable_maintenance}}
{{{deployment.steps.disable_maintenance}}}
{{else}}
# Remove maintenance page
# Restore normal routing
{{/if}}
```

---

## 4. Post-Deployment Validation

### 4.1 Functional Validation

{{#if validation.functional}}
{{#each validation.functional}}
#### {{this.name}}

**Steps:**
{{#each this.steps}}
{{@index}}. {{this}}
{{/each}}

**Expected Result:** {{this.expected}}

**Actual Result:** _______________________

**Status:** [ ] Pass  [ ] Fail

---

{{/each}}
{{else}}
| Test Scenario | Expected Result | Actual Result | Status |
|---------------|-----------------|---------------|--------|
| User login | Successful authentication | | [ ] Pass [ ] Fail |
| Create record | Record created in database | | [ ] Pass [ ] Fail |
| Update record | Record updated successfully | | [ ] Pass [ ] Fail |
| Generate report | Report generated correctly | | [ ] Pass [ ] Fail |
{{/if}}

### 4.2 Performance Validation

{{#if validation.performance}}
{{#each validation.performance}}
- **{{this.metric}}:** Target: {{this.target}}, Actual: _______, Status: [ ] Pass [ ] Fail
{{/each}}
{{else}}
| Metric | Baseline | Target | Actual | Status |
|--------|----------|--------|--------|--------|
| Page load time | 1.5s | ≤ 1.5s | _____ | [ ] Pass [ ] Fail |
| API response time | 200ms | ≤ 200ms | _____ | [ ] Pass [ ] Fail |
| Database query time | 50ms | ≤ 50ms | _____ | [ ] Pass [ ] Fail |
| Concurrent users | 100 | ≥ 100 | _____ | [ ] Pass [ ] Fail |
{{/if}}

### 4.3 Data Validation

{{#if validation.data}}
{{#each validation.data}}
- **{{this.check}}:** {{this.query}}
  - Expected: {{this.expected}}
  - Actual: _____________
  - Status: [ ] Pass [ ] Fail
{{/each}}
{{else}}
```sql
-- Row count validation
SELECT 'customers' as table_name, COUNT(*) as row_count FROM customers
UNION ALL
SELECT 'orders', COUNT(*) FROM orders;
-- Compare with pre-migration counts

-- Data integrity check
SELECT COUNT(*) FROM orders o
LEFT JOIN customers c ON o.customer_id = c.customer_id
WHERE c.customer_id IS NULL;
-- Should return 0 (no orphaned orders)

-- Sample data verification
SELECT * FROM customers LIMIT 10;
-- Manually verify data looks correct
```
{{/if}}

---

## 5. Rollback Plan

### 5.1 Rollback Decision Criteria

{{#if rollback.criteria}}
{{#each rollback.criteria}}
- {{this}}
{{/each}}
{{else}}
**Trigger rollback if ANY of the following occur:**
- Critical functionality is broken (e.g., payment processing fails)
- Data corruption detected
- Performance degradation >50% from baseline
- Security vulnerability discovered
- >20% of users unable to access system
- Database migration fails
- Unable to resolve issue within rollback window (1 hour)
{{/if}}

### 5.2 Rollback Authority

{{#if rollback.authority}}
{{rollback.authority}}
{{else}}
**Authorized to initiate rollback:**
- Deployment Lead
- Application Lead
- Project Manager

**Approval required:** None (pre-approved in deployment plan)

**Notification:** Inform all stakeholders immediately upon rollback decision
{{/if}}

### 5.3 Rollback Procedure

#### Option 1: Blue-Green Rollback (Fastest)

{{#if rollback.blue_green}}
{{{rollback.blue_green}}}
{{else}}
**Duration:** 5-10 minutes

```bash
# Step 1: Switch traffic back to BLUE (old version)
./switch_traffic.sh --from green --to blue

# Step 2: Verify old system is working
curl -f https://api.example.com/health

# Step 3: Stop GREEN environment
ssh prod-green "systemctl stop app-green"

# Step 4: Monitor for stability
tail -f /var/log/app/application.log
```

**Post-Rollback:**
- Database remains migrated (rollback application only)
- If database rollback needed, proceed to Option 2
{{/if}}

#### Option 2: Full Rollback (Database + Application)

{{#if rollback.full}}
{{{rollback.full}}}
{{else}}
**Duration:** 30-60 minutes

**WARNING:** This will lose any data created after deployment

```bash
# Step 1: Enable maintenance mode
./enable_maintenance.sh

# Step 2: Stop new application
systemctl stop app-green

# Step 3: Restore database from backup
pg_restore -h prod-db -U app_user -d app_db /backups/db_backup_20240101.sql

# Step 4: Verify database restore
psql -h prod-db -U app_user -d app_db -c "SELECT COUNT(*) FROM customers"

# Step 5: Switch traffic to BLUE (old application)
./switch_traffic.sh --from green --to blue

# Step 6: Disable maintenance mode
./disable_maintenance.sh

# Step 7: Verify system functionality
./smoke_tests.sh https://api.example.com
```
{{/if}}

### 5.4 Rollback Validation

{{#if rollback.validation}}
{{#each rollback.validation}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] Old application version running
- [ ] Database restored (if applicable)
- [ ] User login working
- [ ] Critical business functions operational
- [ ] No errors in application logs
- [ ] Performance metrics normal
- [ ] Users can access system
{{/if}}

---

## 6. Hypercare & Monitoring

### 6.1 Hypercare Period

{{#if hypercare.duration}}
**Duration:** {{hypercare.duration}}
{{else}}
**Duration:** 4 weeks post-deployment
{{/if}}

**Hypercare Team:**
{{#if hypercare.team}}
{{#each hypercare.team}}
- **{{this.role}}:** {{this.name}} ({{this.availability}})
{{/each}}
{{else}}
- **L1 Support:** 24/7 on-call rotation
- **L2 Support:** Application team (business hours + on-call)
- **L3 Support:** Senior developers (on-call for critical issues)
{{/if}}

### 6.2 Monitoring Strategy

{{#if monitoring.strategy}}
{{monitoring.strategy}}
{{else}}
**Immediate (First 24 hours):**
- Continuous monitoring of application logs
- Dashboard monitoring (refresh every 5 minutes)
- User feedback monitoring

**Week 1:**
- Daily health checks
- Daily review of error logs
- Daily performance report
- Daily stakeholder update

**Weeks 2-4:**
- Bi-weekly health checks
- Weekly performance report
- Weekly stakeholder update
{{/if}}

### 6.3 Key Metrics to Monitor

{{#if monitoring.metrics}}
| Metric | Threshold | Alert | Action |
|--------|-----------|-------|--------|
{{#each monitoring.metrics}}
| {{this.name}} | {{this.threshold}} | {{this.alert}} | {{this.action}} |
{{/each}}
{{else}}
| Metric | Threshold | Alert | Action |
|--------|-----------|-------|--------|
| Error Rate | >1% | Critical | Immediate investigation |
| API Response Time | >2s | Warning | Performance analysis |
| Database Connections | >80% pool | Warning | Scale up or investigate |
| CPU Utilization | >80% | Warning | Scale up or investigate |
| Memory Usage | >90% | Critical | Immediate investigation |
| Disk Space | <10% free | Critical | Clear space or scale |
{{/if}}

### 6.4 Incident Response

{{#if incident.response}}
{{incident.response}}
{{else}}
**Process:**
1. **Detection:** Monitoring alert or user report
2. **Triage:** Assess severity and impact (5 minutes)
3. **Escalation:** Notify appropriate team members
4. **Investigation:** Identify root cause
5. **Resolution:** Apply fix or rollback if critical
6. **Documentation:** Document incident and resolution
7. **Post-Mortem:** Review and identify improvements (within 48 hours for critical incidents)

**Severity Levels:**
- **P1 (Critical):** System down, data loss, security breach
  - Response: Immediate (24/7)
  - Resolution Target: 1 hour
- **P2 (High):** Major feature broken, performance degraded >50%
  - Response: 1 hour (business hours), 4 hours (after hours)
  - Resolution Target: 4 hours
- **P3 (Medium):** Minor feature broken, workaround exists
  - Response: 4 hours (business hours)
  - Resolution Target: 1 business day
- **P4 (Low):** Cosmetic issue, minor inconvenience
  - Response: Next business day
  - Resolution Target: Next release
{{/if}}

---

## 7. Communication Plan

### 7.1 Stakeholder Communication

{{#if communication.stakeholders}}
{{#each communication.stakeholders}}
**{{this.group}}:**
- **Method:** {{this.method}}
- **Frequency:** {{this.frequency}}
- **Content:** {{this.content}}
{{/each}}
{{else}}
**Executive Management:**
- **Method:** Email summary
- **Frequency:** Major milestones only
- **Content:** Go/No-go decision, deployment complete, rollback (if any)

**Business Users:**
- **Method:** Email + in-app notification
- **Frequency:** Before deployment, after completion
- **Content:** Downtime window, new features, known issues

**Support Team:**
- **Method:** Slack + email
- **Frequency:** Before, during, and after deployment
- **Content:** Changes, known issues, troubleshooting guide

**Development Team:**
- **Method:** Slack
- **Frequency:** Real-time during deployment
- **Content:** Step completion, issues encountered
{{/if}}

### 7.2 Communication Templates

#### Pre-Deployment Notification
{{#if communication.templates.pre_deployment}}
{{{communication.templates.pre_deployment}}}
{{else}}
```
Subject: [PROJECT] System Maintenance - [DATE]

Dear Users,

We will be performing system maintenance for the migration to our new platform.

Maintenance Window: [DATE] [TIME] - [TIME]
Expected Downtime: [DURATION]
Impact: [DESCRIPTION]

During this time, the system will be unavailable. We apologize for any inconvenience.

For questions, please contact [SUPPORT EMAIL].

Thank you for your patience.
```
{{/if}}

#### Deployment Success Notification
{{#if communication.templates.success}}
{{{communication.templates.success}}}
{{else}}
```
Subject: [PROJECT] Migration Completed Successfully

The system migration has been completed successfully.

- New version deployed
- All validation tests passed
- System is now available

Please report any issues to [SUPPORT EMAIL].

Thank you for your cooperation.
```
{{/if}}

#### Rollback Notification
{{#if communication.templates.rollback}}
{{{communication.templates.rollback}}}
{{else}}
```
Subject: [URGENT] [PROJECT] Deployment Rolled Back

Due to technical issues, we have rolled back the deployment to the previous version.

Current Status: Previous version restored and operational
Impact: [DESCRIPTION OF ANY DATA LOSS OR IMPACT]
Next Steps: [PLAN FOR RE-DEPLOYMENT]

We apologize for the inconvenience. We will provide updates as they become available.

For urgent issues, please contact [ON-CALL NUMBER].
```
{{/if}}

---

## 8. Contingency Planning

### 8.1 Common Issues & Resolutions

{{#if contingency.issues}}
{{#each contingency.issues}}
**Issue:** {{this.issue}}

**Symptoms:** {{this.symptoms}}

**Resolution:**
{{this.resolution}}

---

{{/each}}
{{else}}
**Issue:** Database connection pool exhausted

**Symptoms:** "Connection timeout" errors, slow response times

**Resolution:**
```bash
# Increase connection pool size
# Edit application.yml:
spring.datasource.hikari.maximum-pool-size=50

# Restart application
systemctl restart app
```

**Issue:** High CPU usage

**Symptoms:** Slow response times, timeouts

**Resolution:**
- Check for long-running queries: `SELECT * FROM pg_stat_activity WHERE state = 'active' AND query_start < now() - interval '1 minute'`
- Kill long-running queries if needed
- Scale horizontally (add more instances)

**Issue:** Disk space full

**Symptoms:** "No space left on device" errors

**Resolution:**
```bash
# Clear old logs
find /var/log/app -name "*.log" -mtime +7 -delete

# Clear temp files
rm -rf /tmp/*

# Expand disk if needed
```
{{/if}}

---

## 9. Post-Deployment Tasks

### 9.1 Immediate Tasks (Within 24 hours)

{{#if post_deployment.immediate}}
{{#each post_deployment.immediate}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] Send deployment success notification
- [ ] Update status page
- [ ] Archive old application version (BLUE environment)
- [ ] Document any issues encountered during deployment
- [ ] Update runbook with any new procedures
- [ ] Schedule post-deployment review meeting
{{/if}}

### 9.2 Short-term Tasks (Within 1 week)

{{#if post_deployment.short_term}}
{{#each post_deployment.short_term}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] Conduct post-deployment review meeting
- [ ] Update documentation with lessons learned
- [ ] Analyze performance metrics and optimize if needed
- [ ] Review and close deployment-related tickets
- [ ] Plan for decommissioning old system (if applicable)
{{/if}}

### 9.3 Long-term Tasks (Within 1 month)

{{#if post_deployment.long_term}}
{{#each post_deployment.long_term}}
- [ ] {{this}}
{{/each}}
{{else}}
- [ ] Decommission old system and infrastructure
- [ ] Archive old system data
- [ ] Update disaster recovery plans
- [ ] Conduct knowledge transfer sessions
- [ ] Publish case study or lessons learned document
{{/if}}

---

## 10. Appendices

### Appendix A: Configuration Files

{{#if appendix.config_files}}
{{#each appendix.config_files}}
#### {{this.name}}

```{{this.language}}
{{{this.content}}}
```

---

{{/each}}
{{/if}}

### Appendix B: Deployment Scripts

{{#if appendix.scripts}}
*[All deployment scripts stored in /scripts directory]*
{{/if}}

### Appendix C: Contact List

{{#if appendix.contacts}}
| Name | Role | Phone | Email |
|------|------|-------|-------|
{{#each appendix.contacts}}
| {{this.name}} | {{this.role}} | {{this.phone}} | {{this.email}} |
{{/each}}
{{/if}}

### Appendix D: Runbook

{{#if appendix.runbook}}
*[See separate runbook document for operational procedures]*
{{/if}}

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| {{version}} | {{generated_date}} | {{author}} | Initial version (auto-generated) |

---

**End of Deployment & Rollback Plan**
